<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>用户管理</title>
<link href="../../layui/css/layui.css" rel="stylesheet">
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery-3.6.0.min.js"></script>
<style>
html {
	overflow: hidden;
}
body {
  display: flex;
  flex-direction: column;
  padding: 15px;
  box-sizing: border-box;
  height: 100vh;
  margin: 0;
}
.toolbar {
  margin-bottom: 15px;
}
/* 密码框隐藏/显示控制类 */
.password-group {
    display: none;
}
</style>
</head>
<body>
	<div class="layui-btn-group toolbar">
		<button class="layui-btn layui-btn-normal" id="addUser">
			<i class="layui-icon layui-icon-add-1"></i> 添加用户
		</button>
		<button class="layui-btn layui-btn-danger" id="deleteUser">
			<i class="layui-icon layui-icon-delete"></i> 批量删除
		</button>
	</div>
	
	<table class="layui-hide" id="ID-table-demo-editable"></table>
	
	<div id="userForm" style="display: none; padding: 20px;">
		<form class="layui-form" lay-filter="userFormFilter">
			<div class="layui-form-item">
				<label class="layui-form-label">账户名称</label>
				<div class="layui-input-block">
					<input type="text" name="userName" lay-verify="required" placeholder="请输入账户名称" autocomplete="off" class="layui-input" id="userNameInput">
				</div>
			</div>
			
			<!-- 新增：密码输入框组（默认隐藏，添加时显示） -->
			<div class="layui-form-item password-group" id="passwordGroup">
				<label class="layui-form-label">密码</label>
				<div class="layui-input-block">
					<input type="password" name="password" lay-verify="required|passwordLength" placeholder="请输入密码（6-16位）" autocomplete="off" class="layui-input">
				</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label">网站名称</label>
				<div class="layui-input-block">
					<input type="text" name="name" lay-verify="required" placeholder="请输入网站名称" autocomplete="off" class="layui-input">
				</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label">性别</label>
				<div class="layui-input-block">
					<input type="radio" name="sex" value="男" title="男" checked>
					<input type="radio" name="sex" value="女" title="女">
				</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label">年龄</label>
				<div class="layui-input-block">
					<input type="number" name="age" lay-verify="required|number|ageRange" placeholder="请输入年龄" autocomplete="off" class="layui-input">
				</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label">邮箱</label>
				<div class="layui-input-block">
					<input type="text" name="email" lay-verify="required|email" placeholder="请输入邮箱" autocomplete="off" class="layui-input">
				</div>
			</div>
			
			<div class="layui-form-item">
				<div class="layui-input-block">
					<button class="layui-btn" lay-submit lay-filter="submitUser">提交</button>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>

<script>
	layui.use(['table', 'layer', 'form'], function() {
		var table = layui.table;
		var layer = layui.layer;
		var form = layui.form;
		var $ = layui.$;
		
		// 密码长度校验规则
		form.verify({
			ageRange: function(value) {
				if (value < 0 || value > 120) {
					return '年龄必须在0-120之间';
				}
			},
			passwordLength: function(value) {
				if (value.length < 6 || value.length > 16) {
					return '密码长度必须为6-16位';
				}
			}
		});
		
		var editable = function(d) {
			if (d.editable)
				return 'text';
		};
		
		var tableIns = table.render({
			elem : '#ID-table-demo-editable',
			url : '../../SelectAllUserServlet',
			page : true,
			css : ['.layui-table-view td[data-edit]{color: #16B777;}'].join(''),
			cols : [ [ {
				checkbox : true,
				fixed : true
			}, {
				field : 'userName',
				fixed : 'left',
				width : 150,
				title : '账户名称',
				sort : true
			}, {
				field : 'name',
				width : 150,
				title : '网站名称',
				edit : editable
			}, {
				field : 'sex',
				width : 80,
				title : '性别',
				edit : editable
			}, {
				field : 'age',
				width : 120,
				title : '年龄',
				edit : editable
			}, {
				field : 'email',
				title : '邮箱',
				width : 300,
				edit : editable
			}, {
				fixed: 'right',
				width: 120,
				title: '操作',
				toolbar: '#barDemo'
			} ] ],
			height : 'full-80'
		});
		
		// 添加用户：显示密码框
		$('#addUser').on('click', function() {
			$('#userNameInput').removeAttr('disabled');
			// 显示密码输入框
			$('#passwordGroup').show();
			// 重置表单时清空密码
			form.val('userFormFilter', {
				'userName': '',
				'password': '',
				'name': '',
				'sex': '男',
				'age': '',
				'email': ''
			});
			layer.open({
				type: 1,
				title: '添加用户',
				content: $('#userForm'),
				area: ['500px', '520px'], // 调整弹窗高度（适配密码框）
				success: function() {
					$('#userForm').show();
				}
			});
		});
		
		$('#deleteUser').on('click', function() {
			var checkStatus = table.checkStatus('ID-table-demo-editable');
			var data = checkStatus.data;
			if (data.length === 0) {
				layer.msg('请选择要删除的用户', {icon: 3});
				return;
			}
			var userNames = data.map(item => item.userName).join(',');
			layer.confirm('确定要删除选中的 ' + data.length + ' 个用户吗？', {
				icon: 3,
				title: '确认删除'
			}, function(index) {
				$.ajax({
					url: '../../DeleteUserServlet',
					type: 'post',
					data: {userNames: userNames},
					dataType: 'json',
					success: function(res) {
						if (res.msg === "success") {
							layer.msg('删除成功', {icon: 1, time: 1500}, function() {
								tableIns.reload();
							});
						} else {
							layer.msg('删除失败', {icon: 2});
						}
					},
					error: function() {
						layer.msg('删除失败，请重试', {icon: 2});
					}
				});
				layer.close(index);
			});
		});
		
		// 编辑用户：隐藏密码框
		table.on('tool(ID-table-demo-editable)', function(obj) {
			var data = obj.data;
			if (obj.event === 'del') {
				layer.confirm('确定要删除该用户吗？', function(index) {
					$.ajax({
						url: '../../DeleteUserServlet',
						type: 'post',
						data: {userNames: data.userName},
						dataType: 'json',
						success: function(res) {
							if (res.msg === "success") {
								obj.del();
								layer.msg('删除成功', {icon: 1});
							} else {
								layer.msg('删除失败', {icon: 2});
							}
						},
						error: function() {
							layer.msg('删除失败，请重试', {icon: 2});
						}
					});
					layer.close(index);
				});
			} else if (obj.event === 'edit') {
				$('#userNameInput').attr('disabled', 'disabled');
				// 隐藏密码输入框（编辑时无需修改密码）
				$('#passwordGroup').hide();
				form.val('userFormFilter', {
					'userName': data.userName,
					'password': "123456",
					'name': data.name,
					'sex': data.sex,
					'age': data.age,
					'email': data.email
				});
				layer.open({
					type: 1,
					title: '编辑用户',
					content: $('#userForm'),
					area: ['500px', '450px'], // 恢复原弹窗高度
					success: function() {
						$('#userForm').show();
					}
				});
			}
		});
		
		// 提交表单：添加时传递密码，编辑时不传递
		form.on('submit(submitUser)', function(data) {
			var isAdd = !$('#userNameInput').is(':disabled');
			var submitData = data.field;
			
			// 编辑场景：删除密码字段（避免传递空密码）
			if (!isAdd) {
				delete submitData.password;
			}
			
			$.ajax({
				url: isAdd ? '../../AddUserServlet' : '../../PersonalInfoServlet',
				type: 'post',
				data: submitData,
				dataType: 'json',
				success: function(res) {
					if (res.msg === "success") {
						layer.msg(isAdd ? '添加成功' : '修改成功', {
							icon: 1,
							time: 1500
						}, function() {
							layer.closeAll('page');
							tableIns.reload();
						});
					} else {
						layer.msg(isAdd ? '添加失败' : '修改失败', {icon: 2});
					}
				},
				error: function() {
					layer.msg('操作失败，请重试', {icon: 2});
				}
			});
			return false;
		});
		
		table.on('edit(ID-table-demo-editable)', function(obj) {
			var field = obj.field;
			var value = obj.value;
			var data = obj.data;

			if (value.replace(/\s/g, '') === '') {
				layer.tips('值不能为空', this, {tips : 1});
				return obj.reedit();
			}
			
			if (field === 'age') {
				var intValue = parseInt(value);
				if (isNaN(intValue) || value !== intValue.toString()) {
					layer.tips('年龄必须为数值', this, {tips : 1});
					return obj.reedit();
				}
				if (intValue > 120) {
					layer.tips('年龄过大', this, {tips : 1});
					return obj.reedit();
				}else if(intValue < 0){
					layer.tips('年龄过小', this, {tips : 1});
					return obj.reedit();
				}
			}

			$.ajax({
				url : '../../PersonalInfoServlet',
				type : 'post',
				data : {
					'userName': data.userName,
					'name' : data.name,
					'sex' : data.sex,
					'age' : data.age,
					'email' : data.email
				},
				dataType : "json",
				success : function(res) {
					if (res.msg === "success") {
						layer.msg('修改成功', {icon : 1,time : 1500});
					} else {
						layer.msg('修改失败', {icon : 2,time : 1500});
					}
				}
			});
		});
	});
</script>

<script type="text/html" id="barDemo">
	<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
	<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
</body>
</html>