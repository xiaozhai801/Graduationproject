<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>评论管理</title>
<link href="../../layui/css/layui.css" rel="stylesheet">
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery-3.6.0.min.js"></script>
<style>
html, body {
	overflow: hidden;
	margin: 0;
	padding: 0;
}

.layui-form {
	margin: 15px;
}

.layui-form, #articleTable {
	margin: 0 auto;
	width: fit-content;
}
</style>
</head>
<body>
	<form class="layui-form layui-row layui-col-space16">
		<div class="layui-form-item">

			<!-- 文章ID搜索 -->
			<div class="layui-input-inline">
				<input type="text" name="titleId" placeholder="文章ID"
					class="layui-input" lay-affix="clear" style="width: 150px;">
			</div>
			<!-- 标题搜索 -->
			<div class="layui-input-inline">
				<input type="text" name="topic" placeholder="标题" lay-affix="clear"
					class="layui-input" style="width: 150px;">
			</div>

			<!-- 评论用户搜索 -->
			<div class="layui-input-inline">
				<input type="text" name="name" placeholder="评论用户" lay-affix="clear"
					class="layui-input" style="width: 150px;">
			</div>

			<!-- 搜索按钮 -->
			<div class="layui-input-inline">
				<button class="layui-btn" lay-submit lay-filter="demo-table-search">
					<i class="layui-icon layui-icon-search"></i> 搜索
				</button>
			</div>

		</div>
	</form>

	<table class="layui-hide" id="commentTable"></table>


	<script>
    layui.use(['table', 'form', 'dropdown', 'layer'], function() {
        var table = layui.table;
        var form = layui.form;
        var dropdown = layui.dropdown;
        var layer = layui.layer;
        var $ = layui.jquery;

        // 删除文章函数
        function deleteArticle(titleId) {
            layer.confirm('确定要删除这篇文章吗？', {
                icon: 3,
                title: '提示'
            }, function(index) {
                $.post('', {titleId: titleId}, function(data) {
                    if (data.trim() === "success") {
                        layer.msg('删除成功', {icon: 1});
                        setTimeout(() => table.reload('commentTable'), 500);
                    } else {
                        layer.msg('删除失败: ' + data, {icon: 2});
                    }
                });
                layer.close(index);
            });
        }

        table.render({
            elem: '#commentTable',
            url: '../../CommentServlet',
            page: true,
            cols: [
                [
                    {field: 'titleId', title: '文章ID', width: 150, sort: true, fixed: true},
                    {
                    	field: 'comment',
                    	title: '评论内容',
                    	width: 320,
                        templet: d => `<a href="../Article/CurrentArticle.html?titleId=${d.titleId}">${d.topic || '无标题'}</a>`
                    },
                    {field: 'name', title: '评论用户', width: 120, sort: true},
                    {
                        field: 'topic', 
                        title: '标题', 
                        width: 520,
                        templet: d => `<a href="../Article/CurrentArticle.html?titleId=${d.titleId}">${d.topic || '无标题'}</a>`
                    },
                    {field: 'uploadTime', title: '发布日期', width: 200, sort: true},
                    {
                        field: 'operate',
                        title: '操作',
                        width: 70,
                        templet: d => `
                            <button class="layui-btn layui-btn-xs layui-btn-danger" data-titleid="${d.titleId}">删除</button>
                        `
                    }
                ]
            ],
            height: 'full-100',
            parseData: function(res) {
                return {
                    code: res.code,
                    msg: res.msg,
                    count: res.count,
                    data: res.data || []
                };
            },
            done: function(res, curr, count) {
                // 事件委托绑定删除按钮
                $(document).on('click', '.layui-btn-danger', function() {
                    deleteArticle($(this).data('titleid'));
                });
            }
        });

        // 搜索功能
        form.on('submit(demo-table-search)', function(data) {
            // 阻止表单默认提交
            event.preventDefault();
            
            // 收集搜索参数
            const params = {
                titleId: data.field.titleId,
                topic: data.field.topic,
                name: data.field.name
            };

            // 重载表格
            table.reload('commentTable', {
                url: '../../SearchCommentServlet',
                where: params,
                page: {curr: 1}
            });
            
            return false;
        });
    });
    </script>
</body>
</html>