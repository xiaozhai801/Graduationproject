<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>评论管理</title>
<link href="../../layui/css/layui.css" rel="stylesheet">
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery-3.6.0.min.js"></script>
<style>
html, body {
    overflow: hidden;
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: #f9fafb;
}
/* 统一表单样式 */
.layui-form {
    margin: 15px;
    width: fit-content;
    margin: 0 auto;
}
/* 优化表格链接交互 */
.layui-table-link:hover {
    color: #1E9FFF;
    text-decoration: underline;
}
/* 统一输入框与按钮对齐方式 */
.layui-input-inline {
    vertical-align: middle;
}
/* 优化操作按钮间距 */
.layui-table-cell .layui-btn {
    margin-right: 5px;
}
/* 最后一个按钮去除右边距 */
.layui-table-cell .layui-btn:last-child {
    margin-right: 0;
}
</style>
</head>
<body>
    <form class="layui-form layui-row layui-col-space16">
        <div class="layui-form-item">
            <!-- 文章ID搜索 -->
            <div class="layui-input-inline">
                <input type="text" name="articleId" placeholder="文章ID" class="layui-input" lay-affix="clear" style="width: 150px;">
            </div>
            <!-- 标题搜索 -->
            <div class="layui-input-inline">
                <input type="text" name="topic" placeholder="标题" lay-affix="clear" class="layui-input" style="width: 150px;">
            </div>
            <!-- 评论用户搜索 -->
            <div class="layui-input-inline">
                <input type="text" name="name" placeholder="评论用户" lay-affix="clear" class="layui-input" style="width: 150px;">
            </div>
            <!-- 搜索按钮 -->
            <div class="layui-input-inline">
                <button class="layui-btn" lay-submit lay-filter="demo-table-search">
                    <i class="layui-icon layui-icon-search"></i> 搜索
                </button>
            </div>
        </div>
    </form>

    <table class="layui-hide" id="commentTable"></table>


    <script>
    layui.use(['table', 'form', 'layer'], function() {
        var table = layui.table;
        var form = layui.form;
        var layer = layui.layer;
        var $ = layui.jquery;

        function deleteComment(commentId) {      
            if (!commentId || typeof commentId !== 'string' || commentId.trim() === '') {
                layer.msg('评论ID不存在', {icon: 2});
                return;
            }
            
            layer.confirm('确定要删除这条评论吗？', {
                icon: 3,
                title: '提示'
            }, function(index) {
                $.get('../../DeleteCommentServlet', {commentId: commentId}, function(data) {
                    if (data.code === 0 && data.msg === "success") {
                        layer.msg('删除成功', {icon: 1});
                        setTimeout(() => {
                            table.reload('commentTable');
                        }, 500);
                    } else {
                        layer.msg('删除失败: ' + (data.msg || '未知错误'), {icon: 2});
                    }
                }, 'json').fail(function(xhr, status, error) {
                    layer.msg('请求失败: ' + error, {icon: 2});
                });
                layer.close(index);
            });
        }

        table.render({
            elem: '#commentTable',
            url: '../../CommentServlet',
            page: true,
            cols: [
                [
                    {field: 'commentId', title: '评论ID', width: 125, sort: true, fixed: true},
                    {field: 'articleId', title: '文章ID', width: 150, sort: true, fixed: true},
                    {
                        field: 'comment',
                        title: '评论内容',
                        width: 320,
                        templet: d => d.comment || '无评论内容'
                    },
                    {field: 'name', title: '评论用户', width: 120, sort: true},
                    {
                        field: 'topic', 
                        title: '文章标题', 
                        width: 520,
                        templet: d => `<a class="layui-table-link" href="CurrentArticle.html?articleId=${d.articleId}">${d.topic || '无标题'}</a>`
                    },
                    {field: 'uploadTime', title: '发布日期', width: 200, sort: true},
                    {
                        field: 'operate',
                        title: '操作',
                        width: 70,
                        templet: d => `<button class="layui-btn layui-btn-xs layui-btn-danger delete-btn" data-id="${d.commentId.toString()}">删除</button>`
                    }
                ]
            ],
            height: 'full-130',
            error: function(res) {
                layer.msg('表格加载失败，请检查接口或网络', { icon: 2 });
            },
            parseData: function(res) {
                return {
                    code: res.code,
                    msg: res.msg,
                    count: res.count,
                    data: res.data || []
                };
            },
            done: function() {
                $('.delete-btn').off('click').on('click', function() {
                    var commentId = $(this).attr('data-id');
                    deleteComment(commentId);
                });
            }
        });

        // 搜索功能
        form.on('submit(demo-table-search)', function(data) {
            // 收集搜索参数
            const params = {
                articleId: data.field.articleId,
                topic: data.field.topic,
                name: data.field.name
            };

            // 重载表格
            table.reload('commentTable', {
                url: '../../SearchCommentServlet',
                where: params,
                page: {curr: 1}  // 重置为第一页
            });
            
            return false;
        });
    });
    </script>
</body>
</html>