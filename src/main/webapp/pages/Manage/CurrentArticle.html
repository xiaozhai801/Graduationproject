<!DOCTYPE html>
<html lang="zh-CN">

<head>
<meta charset="UTF-8">
<title>当前文章</title>
<link href="../../layui/css/layui.css" rel="stylesheet">
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery-3.6.0.min.js"></script>
<style>
body {
	margin: 0;
	padding: 0;
	min-height: 100vh;
	background-color: #f2f2f2;
}

.article-container {
	padding: 15px;
	max-width: 1200px;
	margin: 0 auto;
}

.article-content {
	line-height: 1.8;
	font-size: 16px;
	padding: 20px;
	background: #fff;
	border-radius: 2px;
	box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
	min-height: 400px;
}

.article-title {
	margin-bottom: 20px;
	padding-bottom: 10px;
	border-bottom: 1px solid #eee;
	font-size: 24px;
}

.topic-container {
	padding: 15px 20px;
	border: 1px solid #e5e7eb;
	border-radius: 4px;
	margin-bottom: 20px;
	font-size: 1.25rem;
	font-weight: 600;
}

.comment-item {
	margin: 10px 0;
	padding: 15px;
	background: #fff;
	border-radius: 4px;
	box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.action-buttons {
	display: flex;
	justify-content: center;
	gap: 20px;
	flex-wrap: wrap;
	margin: 25px 0;
}

.action-buttons .layui-col-md4 {
	width: auto;
	float: none;
}

.text-right {
	text-align: right;
}

.comment-section {
	margin-top: 30px;
	padding-top: 20px;
	border-top: 1px solid #eee;
}

.comment-list {
	margin-top: 20px;
}
</style>
</head>

<body>
	<div class="layui-container article-container">
		<div class="layui-card">
			<div class="layui-card-header">
				<div class="layui-col-md12" style="text-align: right;">
					<button class="layui-btn layui-btn-primary" id="btn-back">
						<i class="layui-icon layui-icon-return"></i>返回
					</button>
				</div>
			</div>

			<div class="layui-card-body">
				<div id="topic-container" class="topic-container"></div>
				<div id="content" class="article-content"></div>

<!-- 				<div class="action-buttons layui-row">
					<div class="layui-col-md4">
						<button class="layui-btn layui-btn-primary" id="btn-like">
							<i class="layui-icon"></i><span>点赞</span>
						</button>
					</div>
					<div class="layui-col-md4">
						<button class="layui-btn layui-btn-primary" id="btn-favorite">
							<i class="layui-icon"></i><span>收藏</span>
						</button>
					</div>
					<div class="layui-col-md4">
						<button class="layui-btn layui-btn-primary" id="btn-copylink">
							<i class="layui-icon layui-icon-link"></i>复制链接
						</button>
					</div>
				</div> -->

				<div class="comment-section">
					<h3>
						评论 <span class="layui-badge">0</span>
					</h3>
					<!-- <div class="layui-form">
						<textarea class="layui-textarea" placeholder="请输入你的评论" rows="5"></textarea>
						<button type="button" class="layui-btn layui-btn-normal"
							id="btn-comment" style="margin-top: 10px;">提交评论</button>
					</div> -->
					<div id="comment-list" class="comment-list"></div>
				</div>
			</div>
		</div>
	</div>

	<script>
        const config = {
            urls: {
                article: '../../ArticleDetailServlet',
                action: '../../UpdateUserActionServlet',
                comment: '../../CommentServlet'
            },
            icons: {
                like: ['layui-icon-heart', 'layui-icon-heart-fill'],
                favorite: ['layui-icon-rate', 'layui-icon-rate-solid']
            }
        };

        const state = {
            articleId: new URLSearchParams(window.location.search).get('articleId'),
            isLiked: false,
            isFavorited: false,
            comments: []
        };

        const dom = {
            title: $('#topic-container'),
            content: $('#content'),
            likeBtn: $('#btn-like'),
            favoriteBtn: $('#btn-favorite'),
            commentList: $('#comment-list'),
            commentInput: $('.layui-textarea'),
            commentCount: $('.comment-section h3 .layui-badge')
        };

        const utils = {
            showLoading: () => layui.layer.load(1, { shade: 0.3 }),
            hideLoading: () => layui.layer.closeAll('loading'),
            showMsg: (msg, icon = 0) => layui.layer.msg(msg, { icon }),
            showError: error => utils.showMsg(`操作失败: ${error}`, 2)
        };

        const core = {
        		async init() {
        		    if (!state.articleId) return utils.showError('缺少文章ID参数');
        		    
        		    try {
        		        utils.showLoading();
        		        const data = await $.ajax({
        		            url: config.urls.article,
        		            type: 'POST',
        		            dataType: 'json',
        		            data: { articleId: state.articleId }
        		        });

        		        if (data.code !== 0 || !data.data || data.data.length === 0) {
        		            throw data.msg || '未获取到文章数据';
        		        }
        		        
        		        const { userActions, articleInfo, userComments } = data.data[0];

        		        dom.title.text(articleInfo.topic);
        		        dom.content.html(articleInfo.dataHtml); // 后端字段是 dataHtml，原代码是 data_html
        		        
        		        const userAction = userActions[0] || {};
        		        state.isLiked = userAction.like;
        		        state.isFavorited = userAction.favorite;
        		        
        		        state.comments = userComments;
        		        
        		        core.updateButtons();
        		        core.renderComments();
        		    } catch (error) {
        		        utils.showError(error);
        		    } finally {
        		        utils.hideLoading();
        		    }
        		},

            updateButtons() {
                const { likeBtn, favoriteBtn } = dom;
                const { icons } = config;
                
                likeBtn.find('i')
                    .removeClass(icons.like)
                    .addClass(state.isLiked ? icons.like[1] : icons.like[0]);
                
                favoriteBtn.find('i')
                    .removeClass(icons.favorite)
                    .addClass(state.isFavorited ? icons.favorite[1] : icons.favorite[0]);
            },

            renderComments() {
                dom.commentList.empty();
                dom.commentCount.text(state.comments.length);
                
                state.comments.forEach(comment => {
                    dom.commentList.append(`
                        <div class="comment-item">
                            <div class="layui-row">
                                <div class="layui-col-md6">
                                    <strong>${comment.name}</strong>
                                </div>
                                <div class="layui-col-md6 text-right">
                                    <span class="layui-badge-rim">${comment.uploadTime}</span>
                                </div>
                            </div>
                            <p style="margin-top: 10px;">${comment.comment}</p>
                        </div>
                    `);
                });
            }
        };

        const handlers = {
            backHandler: () => window.history.back(),

            async likeHandler() {
                state.isLiked = !state.isLiked;
                core.updateButtons();
                
                try {
                    await $.post(config.urls.action, {
                        articleId: state.articleId,
                        like: state.isLiked
                    });
                    utils.showMsg(state.isLiked ? '已点赞' : '已取消点赞', 1);
                } catch (error) {
                    state.isLiked = !state.isLiked;
                    core.updateButtons();
                    utils.showError(error);
                }
            },

            async favoriteHandler() {
                state.isFavorited = !state.isFavorited;
                core.updateButtons();
                
                try {
                    await $.post(config.urls.action, {
                        articleId: state.articleId,
                        favorite: state.isFavorited
                    });
                    utils.showMsg(state.isFavorited ? '已收藏' : '已取消收藏', 1);
                } catch (error) {
                    state.isFavorited = !state.isFavorited;
                    core.updateButtons();
                    utils.showError(error);
                }
            },

            copyHandler: () => {
                navigator.clipboard.writeText(location.href)
                    .then(() => utils.showMsg('链接已复制', 1))
                    .catch(err => utils.showError(err));
            },

            async commentHandler() {
                const content = dom.commentInput.val().trim();
                if (!content) return utils.showMsg('请输入评论内容', 3);
                
                try {
                    await $.post(config.urls.comment, {
                        articleId: state.articleId,
                        comment: content
                    });
                    
                    dom.commentInput.val('');
                    const newComment = {
                        name: '当前用户',
                        comment: content,
                        uploadTime: new Date().toLocaleString()
                    };
                    state.comments.unshift(newComment);
                    core.renderComments();
                    utils.showMsg('评论提交成功', 1);
                } catch (error) {
                    utils.showError(error);
                }
            }
        };

        layui.use(() => {
            $('#btn-back').click(handlers.backHandler);
            $('#btn-like').click(() => handlers.likeHandler());
            $('#btn-favorite').click(() => handlers.favoriteHandler());
            $('#btn-copylink').click(handlers.copyHandler);
            $('#btn-comment').click(handlers.commentHandler);

            core.init();
        });
    </script>
</body>
</html>