<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>待审核文章</title>
<link href="../../layui/css/layui.css" rel="stylesheet">
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery-3.6.0.min.js"></script>
<style>
html, body {
	overflow: hidden;
	margin: 0;
	padding: 0;
}

.layui-form {
	margin: 15px;
}
.layui-form, #articleTable {
	margin: 0 auto;
	width: fit-content;
}
</style>
</head>
<body>
	<form class="layui-form layui-row layui-col-space16">
		<div class="layui-form-item">

			<!-- 文章ID搜索 -->
			<div class="layui-input-inline">
				<input type="text" name="titleId" placeholder="文章ID"
					class="layui-input" lay-affix="clear" style="width: 150px;">
			</div>
			<!-- 标题搜索 -->
			<div class="layui-input-inline">
				<input type="text" name="topic" placeholder="标题" lay-affix="clear"
					class="layui-input" style="width: 150px;">
			</div>

			<!-- 作者搜索 -->
			<div class="layui-input-inline">
				<input type="text" name="name" placeholder="作者" lay-affix="clear"
					class="layui-input" style="width: 150px;">
			</div>

			<!-- 机型下拉菜单 -->
			<div class="layui-input-inline">
				<div class="layui-btn-container">
					<button class="layui-btn demo-dropdown-base" style="width: 120px;">
						<span>机型</span> <i
							class="layui-icon layui-icon-down layui-font-12"></i>
					</button>
				</div>
				<input type="hidden" name="model" id="modelInput">
			</div>

			<!-- 审核状态下拉菜单 -->
			<div class="layui-input-inline">
				<div class="layui-btn-container">
					<button class="layui-btn demo-dropdown-status"
						style="width: 120px;">
						<span>审核状态</span> <i
							class="layui-icon layui-icon-down layui-font-12"></i>
					</button>
				</div>
				<input type="hidden" name="release" id="releaseStatusInput">
			</div>

			<!-- 搜索按钮 -->
			<div class="layui-input-inline">
				<button class="layui-btn" lay-submit lay-filter="demo-table-search">
					<i class="layui-icon layui-icon-search"></i> 搜索
				</button>
			</div>

		</div>
	</form>

	<table class="layui-hide" id="ID-table-demo-search"></table>


	<script>
    layui.use(['table', 'form', 'dropdown', 'layer'], function() {
        var table = layui.table;
        var form = layui.form;
        var dropdown = layui.dropdown;
        var layer = layui.layer;
        var $ = layui.jquery;

        // 初始化机型下拉菜单
        dropdown.render({
            elem: '.demo-dropdown-base',
            data: [
                {title: '全部', value: ''},
                {title: '手机', value: '手机'},
                {title: '笔记本', value: '笔记本'},
                {title: '平板', value: '平板'}
            ],
            click: function(obj) {
                $('.demo-dropdown-base span').text(obj.title);
                $('#modelInput').val(obj.value);
            }
        });

        // 初始化审核状态下拉菜单
        dropdown.render({
            elem: '.demo-dropdown-status',
            data: [
                {title: '全部', value: ''},
                {title: '未审核', value: '0'},
                {title: '审核通过', value: '1'},
                {title: '审核未通过', value: '2'}
            ],
            click: function(obj) {
                $('.demo-dropdown-status span').text(obj.title);
                $('#releaseStatusInput').val(obj.value);
            }
        });

        // 删除文章函数
        function deleteArticle(titleId) {
            layer.confirm('确定要删除这篇文章吗？', {
                icon: 3,
                title: '提示'
            }, function(index) {
                $.post('../../DeleteArticleServlet', {titleId: titleId}, function(data) {
                    if (data.trim() === "success") {
                        layer.msg('删除成功', {icon: 1});
                        setTimeout(() => table.reload('ID-table-demo-search'), 500);
                    } else {
                        layer.msg('删除失败: ' + data, {icon: 2});
                    }
                });
                layer.close(index);
            });
        }

        // 初始化表格
        table.render({
            elem: '#ID-table-demo-search',
            url: '../../SelectAllArticleServlet',
            page: true,
            cols: [
                [
                    {field: 'titleId', title: '文章ID', width: 150, sort: true, fixed: true},
                    {
                        field: 'topic', 
                        title: '标题', 
                        width: 660,
                        templet: d => `<a href="CurrentAuditArticle.html?titleId=${d.titleId}">${d.topic || '无标题'}</a>`
                    },
                    {field: 'name', title: '作者', width: 120, sort: true},
                    {field: 'uploadTime', title: '发布日期', width: 200, sort: true},
                    {field: 'model', title: '机型', width: 100},
                    {
                        field: 'release',
                        title: '审核状态',
                        width: 130,
                        templet: d => ({
                            '0': '<span style="color:#ffb800">未审核</span>',
                            '1': '<span style="color:#009688">审核通过</span>',
                            '2': '<span style="color:#ff5722">审核未通过</span>'
                        }[d.release] || '未知状态')
                    },
                    {
                        field: 'operate',
                        title: '操作',
                        width: 150,
                        templet: d => `
                            <button class="layui-btn layui-btn-xs layui-btn-normal">
                                <a href="CurrentAuditArticle.html?titleId=${d.titleId}" style="color:#fff">查看</a>
                            </button>
                            <button class="layui-btn layui-btn-xs layui-btn-danger" data-titleid="${d.titleId}">删除</button>
                        `
                    }
                ]
            ],
            height: 'full-100',
            done: res => {
                // 事件委托绑定删除按钮
                $(document).on('click', '.layui-btn-danger', function() {
                    deleteArticle($(this).data('titleid'));
                });
            }
        });

        // 搜索功能
        form.on('submit(demo-table-search)', function(data) {
            // 阻止表单默认提交
            event.preventDefault();
            
            // 收集搜索参数
            const params = {
                titleId: data.field.titleId,
                topic: data.field.topic,
                name: data.field.name,
                model: $('#modelInput').val(),
                release: $('#releaseStatusInput').val()
            };

            // 重载表格
            table.reload('ID-table-demo-search', {
                url: '../../SearchArticleServlet',
                where: params,
                page: {curr: 1}
            });
            
            return false;
        });
    });
    </script>
</body>
</html>