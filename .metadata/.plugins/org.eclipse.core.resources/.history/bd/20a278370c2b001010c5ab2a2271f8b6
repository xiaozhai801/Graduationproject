package com.zpq.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.List;

import com.zpq.pojo.Admin;
import com.zpq.pojo.Article;
import com.zpq.pojo.User;
import com.zpq.utils.DBUtil;

public class UserDaoImpl implements UserDao {
	@Override
	public void Updateinformation(int titleId) throws SQLException {
		// TODO Auto-generated method stub
		DBUtil dbUtil = new DBUtil();
		Article article=new Article();
		String selectSql="SELECT (SELECT COUNT(*) FROM c_useractions WHERE titleId =?) as views,likeCount as likes,favoriteCount as favorties FROM c_actioncounts WHERE titleId =?;";
		PreparedStatement ps = dbUtil.getPreparedStatement(selectSql);
		ps.setInt(1, titleId);
		ps.setInt(2, titleId);
		ResultSet rs = ps.executeQuery();
		while (rs.next()) {
			article.setViews(rs.getInt("views"));
			article.setLikes(rs.getInt("likes"));
			article.setFavorites(rs.getInt("favorties"));
		}
		
		String updateSql = "UPDATE v_articleinfo set views=?,likes=?,favorites=? where titleId=?";
		ps = dbUtil.getPreparedStatement(updateSql);
		ps.setInt(1, article.getViews());
		ps.setInt(2, article.getLikes());
		ps.setInt(3, article.getFavorites());
		ps.setInt(4, titleId);
		ps.executeUpdate();
	}

	@Override
	public Admin selectAdmin(String name, String password) throws SQLException {
		Admin admin = new Admin();
		DBUtil dbUtil = new DBUtil();
		String sql = "SELECT * FROM s_admin WHERE name =? AND `password` =?";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setString(1, name);
		ps.setString(2, password);
		ResultSet rs = ps.executeQuery();
		while (rs.next()) {
			admin.setName(rs.getString("name"));
			admin.setPassword(rs.getString("password"));
			return admin;
		}
		return null;
	}

	// 连接数据库查找用户名和密码
	@Override
	public User selectUser(String name, String password) throws SQLException {
		User user = new User();
		DBUtil dbUtil = new DBUtil();
		String sql = "select * from s_user where name=? and `password`=?";
		// 有?占位符，用PerpaerdStatement
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setString(1, name);
		ps.setString(2, password);
		ResultSet rs = ps.executeQuery();
		while (rs.next()) {
			user.setName(rs.getString("name"));
			user.setPassword(rs.getString("password"));
			return user;
		}
		return null;
	}

	@Override
	public List<Object> SelectAllUserLsit(int page, int limit) throws SQLException {
		// TODO Auto-generated method stub
		List<Object> userList = new ArrayList<>();
		DBUtil dbUtil = new DBUtil();
		String sql = "SELECT * FROM v_userinfo LIMIT ?,?";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setInt(1, (page - 1) * limit);
		ps.setInt(2, limit);
		ResultSet rs = ps.executeQuery();
		while (rs.next()) {
			User user = new User();
			// 查询user信息
			user.setUserId(rs.getString("userId"));
			user.setName(rs.getString("name"));
			user.setSex(rs.getString("sex"));
			user.setAge(rs.getInt("age"));
			user.setEmail(rs.getString("email"));
			userList.add(user);
		}
		return userList;
	}

	@Override
	public int countUser() throws SQLException {
		// TODO Auto-generated method stub
		DBUtil dbUtil = new DBUtil();
		String sql = "SELECT count(*) as sum FROM v_userinfo";
		Connection conn = dbUtil.getConnection();
		// 没有?占位符，用Statement
		Statement st = conn.createStatement();
		ResultSet rs = st.executeQuery(sql);
		while (rs.next()) {
			return rs.getInt("sum");
		}
		return 0;
	}

	@Override
	public String addUser(String name, String password) throws SQLException {
		DBUtil dbUtil = new DBUtil();
		String sql = "select * from s_user where name=?";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setString(1, name);
		ResultSet rs = ps.executeQuery();

		// 检查结果集是否有记录
		if (rs.next()) {
			// name 存在返回 null
			return "user exists";
		}

		// 重新初始化 SQL 语句和 PreparedStatement
		sql = "INSERT INTO s_user (NAME, PASSWORD, id) VALUES(?,?,(SELECT id FROM(SELECT id,ROW_NUMBER () OVER (ORDER BY id DESC) AS row_num FROM s_user) subquery WHERE row_num = 1)+1);";
		ps = dbUtil.getPreparedStatement(sql); // 重新获取 PreparedStatement
		ps.setString(1, name);
		ps.setString(2, password);

		// 执行插入操作，对于插入语句使用 executeUpdate
		int rowsAffected = ps.executeUpdate();
		// 添加初始头像
		String avatarSql = "UPDATE v_userinfo SET avatar = '/javaweb/img/test.jpg' WHERE userId = ?";
		PreparedStatement avatarPs = dbUtil.getPreparedStatement(avatarSql);
		avatarPs.setString(1, name);
		int avatarRs = avatarPs.executeUpdate();
		if (avatarRs != 1) {
			return null;
		}

		// 检查是否插入成功
		if (rowsAffected > 0) {
			return "success";
		} else {
			return null;
		}
	}

	@Override
	public int EditUser(User user) throws SQLException {
		// TODO Auto-generated method stub
		DBUtil dbUtil = new DBUtil();
		String sql = "UPDATE v_userinfo SET userId = ?, `name` = ?, sex = ?, age = ?, email = ? WHERE userId = ?;";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setString(1, user.getUserId());
		ps.setString(2, user.getName());
		ps.setString(3, user.getSex());
		ps.setInt(4, user.getAge());
		ps.setString(5, user.getEmail());
		ps.setString(6, user.getUserId());
		int rs = ps.executeUpdate();
		while (rs == 1) {
			return 1;
		}
		return 0;
	}

	@Override
	public int EditPersonalPassword(User user, String newPassword) throws SQLException {
		// TODO Auto-generated method stub
		DBUtil dbUtil = new DBUtil();
		Connection conn = dbUtil.getConnection();

		String sql = "UPDATE s_user SET password = ? WHERE password = ? AND name = ?;";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setString(1, newPassword);
		ps.setString(2, user.getPassword());
		ps.setString(3, user.getName());
		ps.executeUpdate();

		String countSql = "SELECT ROW_COUNT() as count";
		// 没有?占位符，用Statement
		Statement st = conn.createStatement();
		ResultSet rs = st.executeQuery(countSql);
		rs.next();
		if (rs.getInt("count") == 1) {
			return 1;
		}
		return 0;
	}

	@Override
	public int Thumbsup(long id, String userId, int titleId, boolean like) throws SQLException {
		// TODO Auto-generated method stub
		DBUtil dbUtil = new DBUtil();
		String ActionSql = "UPDATE c_useractions SET `like`=? WHERE id=? and userId =? and titleId=?;";
		PreparedStatement ps = dbUtil.getPreparedStatement(ActionSql);
		ps.setBoolean(1, like);
		ps.setLong(2, id);
		ps.setString(3, userId);
		ps.setInt(4, titleId);

		int row = ps.executeUpdate();
		if (row != 1) {
			return -1;
		}

		String likeSql;
		if (like == true) {
			likeSql = "UPDATE c_actioncounts SET likeCount=likeCount+1 WHERE titleId=?;";
		} else {
			likeSql = "UPDATE c_actioncounts SET likeCount=likeCount-1 WHERE titleId=?;";
		}
		ps = dbUtil.getPreparedStatement(likeSql);
		ps.setInt(1, titleId);

		row = ps.executeUpdate();
		Updateinformation(titleId);
		return row;
	}

	@Override
	public int Collect(long id, String userId, int titleId, boolean favorite) throws SQLException {
		// TODO Auto-generated method stub
		DBUtil dbUtil = new DBUtil();
		String sql = "UPDATE c_useractions SET favorite=? WHERE id=? and userId =? and titleId=?;";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setBoolean(1, favorite);
		ps.setLong(2, id);
		ps.setString(3, userId);
		ps.setInt(4, titleId);

		int row = ps.executeUpdate();
		if (row != 1) {
			return -1;
		}

		String favoriteSql;
		if (favorite == true) {
			favoriteSql = "UPDATE c_actioncounts SET favoriteCount=favoriteCount+1 WHERE titleId=?;";
		} else {
			favoriteSql = "UPDATE c_actioncounts SET favoriteCount=favoriteCount-1 WHERE titleId=?;";
		}
		ps = dbUtil.getPreparedStatement(favoriteSql);
		ps.setInt(1, titleId);

		row = ps.executeUpdate();
		Updateinformation(titleId);
		return row;
	}

	@Override
	public int SubmitComment(long id, String userId, int titleId, String comment) throws SQLException {
		// TODO Auto-generated method stub
		DBUtil dbUtil = new DBUtil();
		// 获取当前时间戳
		Timestamp uploadTime = new Timestamp(System.currentTimeMillis());

		SearchElementDao searchElementDao = new SearchElementDaoImpl();
		User user = searchElementDao.searchUserInfo("userId", userId).get(userId);
		String name = user.getName();

		String sql = "INSERT INTO c_usercomment (id, userId, `name`, titleId, `comment`,uploadTime) VALUES (?,?,?,?,?,?);";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setLong(1, id);
		ps.setString(2, userId);
		ps.setString(3, name);
		ps.setInt(4, titleId);
		ps.setString(5, comment);
		ps.setTimestamp(6, uploadTime);

		int row = ps.executeUpdate();
		return row;
	}

	@Override
	public List<Object> SelectMyFavorite(String userId) throws SQLException {
		// TODO Auto-generated method stub
		List<Object> myFavoriteList=new ArrayList<>();
		DBUtil dbUtil = new DBUtil();
		String sql = "SELECT * FROM v_articleinfo where titleId in (SELECT titleId FROM c_useractions where userId=? and favorite=1)";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setString(1, userId);

		ResultSet rs=ps.executeQuery();
		while (rs.next()) {
			Article article = new Article();
			article.setTitleId(rs.getInt("titleId"));
			article.setUserId(rs.getString("userId"));
			article.setName(rs.getString("name"));
			article.setTopic(rs.getString("topic"));
			article.setModel(rs.getString("model"));
			article.setUploadTime(rs.getString("uploadTime"));
			article.setRelease(rs.getInt("release"));
			article.setViews(rs.getInt("views"));
			article.setLikes(rs.getInt("likes"));
			article.setFavorites(rs.getInt("favorites"));
			article.setData_html(rs.getString("data_html"));
			article.setData_text(rs.getString("data_text"));
			myFavoriteList.add(article);
		}
		return myFavoriteList;
	}

	@Override
	public int CountMyFavorite(String userId) throws SQLException {
		// TODO Auto-generated method stub
		DBUtil dbUtil = new DBUtil();
		String sql = "SELECT count(*) as sum FROM c_useractions where userId=? and favorite=1";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setString(1, userId);

		ResultSet rs=ps.executeQuery();
		while (rs.next()) {
			return rs.getInt("sum");
		}
		return 0;
	}

	@Override
	public List<Object> SelectMyLike(String userId) throws SQLException {
		List<Object> myFavoriteList=new ArrayList<>();
		DBUtil dbUtil = new DBUtil();
		String sql = "SELECT * FROM v_articleinfo where titleId in (SELECT titleId FROM c_useractions where userId=? and `like`=1)";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setString(1, userId);

		ResultSet rs=ps.executeQuery();
		while (rs.next()) {
			Article article = new Article();
			article.setTitleId(rs.getInt("titleId"));
			article.setUserId(rs.getString("userId"));
			article.setName(rs.getString("name"));
			article.setTopic(rs.getString("topic"));
			article.setModel(rs.getString("model"));
			article.setUploadTime(rs.getString("uploadTime"));
			article.setRelease(rs.getInt("release"));
			article.setViews(rs.getInt("views"));
			article.setLikes(rs.getInt("likes"));
			article.setFavorites(rs.getInt("favorites"));
			article.setData_html(rs.getString("data_html"));
			article.setData_text(rs.getString("data_text"));
			myFavoriteList.add(article);
		}
		return myFavoriteList;
	}

	@Override
	public int CountMyLike(String userId) throws SQLException {
		// TODO Auto-generated method stub
		DBUtil dbUtil = new DBUtil();
		String sql = "SELECT count(*) as sum FROM c_useractions where userId=? and like=1";
		PreparedStatement ps = dbUtil.getPreparedStatement(sql);
		ps.setString(1, userId);
		System.out.println(ps.toString());
		ResultSet rs=ps.executeQuery();
		while (rs.next()) {
			return rs.getInt("sum");
		}
		return 0;
	}

}