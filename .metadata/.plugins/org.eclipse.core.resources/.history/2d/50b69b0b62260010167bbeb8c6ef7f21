<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>待审核文章</title>
<link href="../..//layui/css/layui.css" rel="stylesheet">
<script src="../..//layui/layui.js"></script>
<script src="../..//js/jquery-3.6.0.min.js"></script>
</head>
<style>
html, body {
	/* overflow-x: hidden; */
	overflow: hidden;
}
</style>
<body>
	<form class="layui-form layui-row layui-col-space16">
		<div class="layui-form-item">
			<div class="layui-input-inline">
				<div class="layui-inline">
					<input type="text" name="titleId" value="" placeholder="文章ID"
						class="layui-input" lay-affix="clear" style="width: 150px;">
				</div>
			</div>

			<div class="layui-input-inline">
				<div class="layui-inline">
					<input type="text" name="topic" placeholder="标题" lay-affix="clear"
						class="layui-input" style="width: 150px;">
				</div>
			</div>

			<div class="layui-input-inline">
				<div class="layui-inline">
					<input type="text" name="name" placeholder="作者" lay-affix="clear"
						class="layui-input" style="width: 150px;">
				</div>
			</div>

			<div class="layui-input-inline">
				<div class="layui-btn-container">
					<button class="layui-btn demo-dropdown-base" style="width: 120px;">
						<span>机型</span> <i
							class="layui-icon layui-icon-down layui-font-12"></i>
					</button>
				</div>
				<!-- 添加隐藏的 input 字段用于保存机型值 -->
				<input type="hidden" name="model" id="modelInput">
			</div>

			<div class="layui-input-inline">
				<div class="layui-btn-container">
					<button class="layui-btn demo-dropdown-status"
						style="width: 120px;">
						<span>审核状态</span> <i
							class="layui-icon layui-icon-down layui-font-12"></i>
					</button>
				</div>
				<!-- 添加隐藏的 input 字段用于保存审核状态值 -->
				<input type="hidden" name="release" id="releaseStatusInput">
			</div>

			<div class="layui-input-inline">
				<div class="layui-btn-container layui-col-xs12">
					<button class="layui-btn" lay-submit lay-filter="demo-table-search">
						<i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
					</button>
				</div>
			</div>
		</div>
	</form>
	<table class="layui-hide" id="ID-table-demo-search"></table>

	<script>
    layui.use(['table', 'form', 'dropdown', 'layer'], function() {
        var table = layui.table;
        var form = layui.form;
        var dropdown = layui.dropdown;
        var layer = layui.layer;

        // 定义删除函数（作用域内）
        function deleteArticle(titleId) {
            layer.confirm('确定要删除这篇文章吗？', {
                icon: 3,
                title: '提示'
            }, function(index) {
                $.ajax({
                    type: 'POST',
                    url: '../../DeleteArticleServlet',
                    data: { titleId: titleId },
                    dataType: 'text',
                    success: function(data) {
                        if (data.trim() === "success") {
                            layer.msg('删除成功', { icon: 1 });
                            // 延迟500毫秒刷新表格
                            setTimeout(function() {
                                table.reload('ID-table-demo-search');
                            }, 500);
                        } else {
                            layer.msg('删除失败: ' + data, { icon: 2 });
                        }
                    },
                    error: function(xhr) {
                        layer.msg('请求出错: ' + xhr.status + ' ' + xhr.statusText, { icon: 2 });
                    }
                });
                layer.close(index);
            });
        }

        // 初始化表格
        table.render({
            elem: '#ID-table-demo-search',
            url: '../../SelectAllArticleServlet',
            page: true,
            cols: [
                [
                    { field: 'titleId', title: '文章ID', width: 150, sort: true, fixed: true },
                    {
                        field: 'topic', 
                        title: '标题', 
                        width: 740,
                        templet: function(d) {
                            return '<a href="CurrentAuditArticle.html?titleId=' + d.titleId + '">' + (d.topic || '') + '</a>';
                        }
                    },
                    { field: 'name', title: '作者', width: 120, sort: true },
                    { field: 'uploadTime', title: '发布日期', width: 200, sort: true },
                    { field: 'model', title: '机型', width: 100 },
                    {
                        field: 'release',
                        title: '审核状态',
                        width: 130,
                        templet: function(d) {
                            return {
                                '0': '<span style="color:#ffb800">未审核</span>',
                                '1': '<span style="color:#009688">审核通过</span>',
                                '2': '<span style="color:#ff5722">审核未通过</span>'
                            }[d.release] || '未知状态';
                        }
                    },
                    {
                        field: 'operate',
                        title: '操作',
                        width: 150,
                        templet: function(d) {
                            return '<button class="layui-btn layui-btn-xs layui-btn-normal">' +
                                      '<a href="CurrentAuditArticle.html?titleId=' + d.titleId + '" style="color:#fff">查看</a>' +
                                   '</button>' +
                                   '<button class="layui-btn layui-btn-xs layui-btn-danger" data-titleid="' + d.titleId + '">删除</button>';
                        }
                    }
                ]
            ],
            height: 'full-55',
            done: function(res, curr, count) {
                // 绑定删除事件（使用事件委托）
                $(document).off('click', '.layui-btn-danger').on('click', '.layui-btn-danger', function() {
                    var titleId = $(this).data('titleid');
                    if (titleId) {
                        deleteArticle(titleId);
                    } else {
                        layer.msg('获取文章ID失败', { icon: 2 });
                    }
                })
            }
        });

        // 其他初始化代码（保持原样）
        dropdown.render({ /* 机型下拉配置 */ });
        dropdown.render({ /* 审核状态下拉配置 */ });
        form.on('submit(demo-table-search)', function(data) { /* 搜索功能 */ });
    });
    </script>
</body>

</html>