package com.zpq.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import com.zpq.pojo.Article;
import com.zpq.utils.DBUtil;

public class ArticleDaoImpl implements ArticleDao {

    // 分页显示所有文章的方法
    @Override
    public List<Object> selectArticle(int page, int limit) throws SQLException {
        // 用于存储查询到的文章对象的列表
        List<Object> articleList = new ArrayList<>();
        // 创建数据库工具类实例，用于获取数据库连接和操作数据库
        DBUtil dbUtil = new DBUtil();
        // SQL语句，使用LIMIT进行分页查询，?为占位符
        String sql = "SELECT * FROM v_articleinfo LIMIT ?,?";
        // 获取预编译的SQL语句对象
        PreparedStatement ps = dbUtil.getPreparedStatement(sql);
        // 设置LIMIT子句的第一个参数，即偏移量，(page - 1) * limit计算出从哪条数据开始查询
        ps.setInt(1, (page - 1) * limit);
        // 设置LIMIT子句的第二个参数，即每页显示的记录数
        ps.setInt(2, limit);
        // 执行SQL查询，并获取结果集
        ResultSet rs = ps.executeQuery();
        // 遍历结果集，将每一条记录封装成Article对象并添加到articleList中
        while (rs.next()) {
            Article article = new Article();
            article.setTitleId(rs.getInt("titleId"));
            article.setUserId(rs.getString("userId"));
            article.setName(rs.getString("name"));
            article.setTopic(rs.getString("topic"));
            article.setModel(rs.getString("model"));
            article.setUploadTime(rs.getString("uploadTime"));
            article.setRelease(rs.getInt("release"));
            article.setViews(rs.getInt("views"));
            article.setLikes(rs.getInt("likes"));
            articleList.add(article);
        }
        // 返回查询到的文章对象列表
        return articleList;
    }

    // 获取所有文章数量的方法
    @Override
    public int countArticle() throws SQLException {
        // 创建数据库工具类实例
        DBUtil dbUtil = new DBUtil();
        // SQL语句，统计v_articleinfo表中的记录数量，使用count(*)函数，并将结果命名为sum
        String sql = "SELECT count(*) as sum FROM v_articleinfo";
        // 获取数据库连接
        Connection conn = dbUtil.getConnection();
        // 因为SQL语句中没有占位符，所以使用Statement对象执行SQL语句
        java.sql.Statement st = conn.createStatement();
        // 执行SQL查询，并获取结果集
        ResultSet rs = st.executeQuery(sql);
        // 遍历结果集，获取统计的文章数量并返回
        while (rs.next()) {
            return rs.getInt("sum");
        }
        // 如果没有查询到结果，返回0
        return 0;
    }

    // 根据关键词搜索文章的方法
    @Override
    public List<Object> searchArticle(Article article, int page, int limit) throws SQLException {
        // 用于存储搜索到的文章对象的列表
        List<Object> searchArticleList = new ArrayList<>();
        // 创建数据库工具类实例
        DBUtil dbUtil = new DBUtil();
        // 使用StringBuilder构建SQL查询语句，初始语句为查询所有记录的基础部分，并添加WHERE 1=1方便后续拼接条件
        StringBuilder sqlBuilder = new StringBuilder("SELECT * FROM v_articleinfo WHERE 1=1");
        int titleId = article.getTitleId();
        String topic = article.getTopic();
        String name = article.getName();
        String model = article.getModel();
        List<Object> params = new ArrayList<>();

        // 如果文章ID不为-1，说明有文章ID的查询条件，添加到SQL语句中，并将参数值添加到params列表
        if (titleId != -1) {
            sqlBuilder.append(" AND CAST(titleId AS CHAR) LIKE ?");
            params.add("%" + titleId + "%");
        }
        // 如果文章标题不为null，说明有文章标题的查询条件，添加到SQL语句中，并将参数值添加到params列表
        if (topic != null) {
            sqlBuilder.append(" AND topic LIKE ?");
            params.add("%" + topic + "%");
        }
        // 如果文章作者不为null，说明有文章作者的查询条件，添加到SQL语句中，并将参数值添加到params列表
        if (name != null) {
            sqlBuilder.append(" AND name LIKE ?");
            params.add("%" + name + "%");
        }
        // 如果文章机型不为null，说明有文章机型的查询条件，添加到SQL语句中，并将参数值添加到params列表
        if (model != null) {
            sqlBuilder.append(" AND model LIKE ?");
            params.add("%" + model + "%");
        }

        // 添加分页查询的LIMIT子句到SQL语句中，并将分页参数值添加到params列表
        sqlBuilder.append(" LIMIT ?,?");
        params.add((page - 1) * limit);
        params.add(limit);

        // 将StringBuilder中的内容转换为完整的SQL语句字符串
        String sql = sqlBuilder.toString();

        // 获取预编译的SQL语句对象
        PreparedStatement ps = dbUtil.getPreparedStatement(sql);
        // 遍历params列表，为预编译语句的占位符设置对应的参数值
        for (int i = 0; i < params.size(); i++) {
            ps.setObject(i + 1, params.get(i));
        }

        // 执行SQL查询，并获取结果集
        ResultSet rs = ps.executeQuery();
        // 遍历结果集，将每一条记录封装成Article对象并添加到searchArticleList中
        while (rs.next()) {
            Article searchArticle = new Article();
            searchArticle.setTitleId(rs.getInt("titleId"));
            searchArticle.setUserId(rs.getString("userId"));
            searchArticle.setName(rs.getString("name"));
            searchArticle.setTopic(rs.getString("topic"));
            searchArticle.setModel(rs.getString("model"));
            searchArticle.setUploadTime(rs.getString("uploadTime"));
            searchArticle.setRelease(rs.getInt("release"));
            searchArticle.setViews(rs.getInt("views"));
            searchArticle.setLikes(rs.getInt("likes"));
            searchArticleList.add(searchArticle);
        }
        // 返回搜索到的文章对象列表
        return searchArticleList;
    }

    // 显示我的文章
    @Override
    public List<Object> selectMyArticle(String userId, int page, int limit) throws SQLException {
        // 用于存储查询到的文章对象的列表
        List<Object> articleList = new ArrayList<>();
        // 创建数据库工具类实例，用于获取数据库连接和操作数据库
        DBUtil dbUtil = new DBUtil();
        // SQL语句，使用LIMIT进行分页查询，?为占位符
        String sql = "SELECT * FROM v_articleinfo where userId=? LIMIT ?,?";
        // 获取预编译的SQL语句对象
        PreparedStatement ps = dbUtil.getPreparedStatement(sql);
        // 设置where字句的第一个参数,即查询的用户
        ps.setString(1, userId);
        // 设置LIMIT子句的第一个参数，即偏移量，(page - 1) * limit计算出从哪条数据开始查询
        ps.setInt(2, (page - 1) * limit);
        // 设置LIMIT子句的第二个参数，即每页显示的记录数
        ps.setInt(3, limit);
        // 执行SQL查询，并获取结果集
        ResultSet rs = ps.executeQuery();
        // 遍历结果集，将每一条记录封装成Article对象并添加到articleList中
        while (rs.next()) {
            Article article = new Article();
            article.setTitleId(rs.getInt("titleId"));
            article.setUserId(rs.getString("userId"));
            article.setName(rs.getString("name"));
            article.setTopic(rs.getString("topic"));
            article.setModel(rs.getString("model"));
            article.setUploadTime(rs.getString("uploadTime"));
            article.setRelease(rs.getInt("release"));
            article.setViews(rs.getInt("views"));
            article.setLikes(rs.getInt("likes"));
            articleList.add(article);
        }
        // 返回查询到的文章对象列表
        return articleList;
    }

    @Override
    public int countMyArticle(String userId) throws SQLException {
        // 创建数据库工具类实例
        DBUtil dbUtil = new DBUtil();
        // SQL语句，统计v_articleinfo表中的记录数量，使用count(*)函数，并将结果命名为sum
        String sql = "SELECT count(*) as sum FROM v_articleinfo where userId = ?";
        // 获取预编译的SQL语句对象
        PreparedStatement ps = dbUtil.getPreparedStatement(sql);
        ps.setString(1, userId);
        // 执行SQL查询，并获取结果集
        ResultSet rs = ps.executeQuery();
        // 遍历结果集，获取统计的文章数量并返回
        while (rs.next()) {
            return rs.getInt("sum");
        }
        // 如果没有查询到结果，返回0
        return 0;
    }

    @Override
    public List<Object> searchMyArticle(Article article, int page, int limit) throws SQLException {
        // 用于存储搜索到的文章对象的列表
        List<Object> searchArticleList = new ArrayList<>();
        // 创建数据库工具类实例
        DBUtil dbUtil = new DBUtil();
        // 使用StringBuilder构建SQL查询语句，初始语句为查询所有记录的基础部分，并添加WHERE 1=1方便后续拼接条件
        StringBuilder sqlBuilder = new StringBuilder("SELECT * FROM v_articleinfo WHERE 1=1");
        int titleId = article.getTitleId();
        String topic = article.getTopic();
        String userId = article.getUserId();
        String model = article.getModel();
        List<Object> params = new ArrayList<>();

        // 如果文章ID不为-1，说明有文章ID的查询条件，添加到SQL语句中，并将参数值添加到params列表
        if (titleId != -1) {
            sqlBuilder.append(" AND CAST(titleId AS CHAR) LIKE ?");
            params.add("%" + titleId + "%");
        }
        // 如果文章标题不为null，说明有文章标题的查询条件，添加到SQL语句中，并将参数值添加到params列表
        if (topic != null) {
            sqlBuilder.append(" AND topic LIKE ?");
            params.add("%" + topic + "%");
        }
        // 文章作者ID的查询条件，添加到SQL语句中，并将参数值添加到params列表
        sqlBuilder.append(" AND userId = ?");
        params.add(userId);
        // 如果文章机型不为null，说明有文章机型的查询条件，添加到SQL语句中，并将参数值添加到params列表
        if (model != null) {
            sqlBuilder.append(" AND model LIKE ?");
            params.add("%" + model + "%");
        }

        // 添加分页查询的LIMIT子句到SQL语句中，并将分页参数值添加到params列表
        sqlBuilder.append(" LIMIT ?,?");
        params.add((page - 1) * limit);
        params.add(limit);

        // 将StringBuilder中的内容转换为完整的SQL语句字符串
        String sql = sqlBuilder.toString();

        // 获取预编译的SQL语句对象
        PreparedStatement ps = dbUtil.getPreparedStatement(sql);
        // 遍历params列表，为预编译语句的占位符设置对应的参数值
        for (int i = 0; i < params.size(); i++) {
            ps.setObject(i + 1, params.get(i));
        }

        // 执行SQL查询，并获取结果集
        ResultSet rs = ps.executeQuery();
        // 遍历结果集，将每一条记录封装成Article对象并添加到searchArticleList中
        while (rs.next()) {
            Article searchArticle = new Article();
            searchArticle.setTitleId(rs.getInt("titleId"));
            searchArticle.setUserId(rs.getString("userId"));
            searchArticle.setName(rs.getString("name"));
            searchArticle.setTopic(rs.getString("topic"));
            searchArticle.setModel(rs.getString("model"));
            searchArticle.setUploadTime(rs.getString("uploadTime"));
            searchArticle.setRelease(rs.getInt("release"));
            searchArticle.setViews(rs.getInt("views"));
            searchArticle.setLikes(rs.getInt("likes"));
            searchArticleList.add(searchArticle);
        }
        System.out.println(sql);
        // 返回搜索到的文章对象列表
        return searchArticleList;
    }
}    